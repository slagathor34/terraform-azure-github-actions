name: 'Repository Setup'

on:
  workflow_dispatch:
    inputs:
      initialize_terraform_state:
        description: 'Initialize Terraform state backend'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  id-token: write

jobs:
  setup:
    name: 'Initialize Repository'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        auth-type: SERVICE_PRINCIPAL
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Setup Terraform State Backend
      if: ${{ github.event.inputs.initialize_terraform_state == 'true' }}
      run: |
        echo "Setting up Terraform state backend..."
        
        # Create resource group for Terraform state
        az group create --name "tfstate-rg" --location "East US" --tags "ManagedBy=terraform" "Purpose=tfstate"
        
        # Create storage account for Terraform state
        STORAGE_ACCOUNT_NAME="tfstate${{ secrets.AZURE_SUBSCRIPTION_ID }}$(echo $RANDOM | md5sum | head -c 6)"
        STORAGE_ACCOUNT_NAME=$(echo $STORAGE_ACCOUNT_NAME | tr '[:upper:]' '[:lower:]' | head -c 24)
        
        az storage account create \
          --name $STORAGE_ACCOUNT_NAME \
          --resource-group "tfstate-rg" \
          --location "East US" \
          --sku "Standard_LRS" \
          --tags "ManagedBy=terraform" "Purpose=tfstate"
        
        # Create container for Terraform state
        az storage container create \
          --name "tfstate" \
          --account-name $STORAGE_ACCOUNT_NAME
        
        echo "✅ Terraform state backend created successfully!"
        echo "Storage Account: $STORAGE_ACCOUNT_NAME"
        
        # Add to summary
        echo "## Repository Setup Complete! 🚀" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Terraform State Backend" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Group**: tfstate-rg" >> $GITHUB_STEP_SUMMARY
        echo "- **Storage Account**: $STORAGE_ACCOUNT_NAME" >> $GITHUB_STEP_SUMMARY
        echo "- **Container**: tfstate" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Customize the Terraform variables in \`terraform/terraform.tfvars.example\`" >> $GITHUB_STEP_SUMMARY
        echo "2. Copy to \`terraform/terraform.tfvars\` and update values" >> $GITHUB_STEP_SUMMARY
        echo "3. Create a pull request to test the Terraform plan workflow" >> $GITHUB_STEP_SUMMARY
        echo "4. Merge to main to deploy your infrastructure" >> $GITHUB_STEP_SUMMARY

    - name: Repository Information
      run: |
        echo "## Repository Structure Created" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Your repository now includes:" >> $GITHUB_STEP_SUMMARY
        echo "- 📁 Terraform configuration files" >> $GITHUB_STEP_SUMMARY
        echo "- 🔄 GitHub Actions workflows for CI/CD" >> $GITHUB_STEP_SUMMARY
        echo "- 📝 Documentation and contributing guidelines" >> $GITHUB_STEP_SUMMARY
        echo "- 🛠️ Azure authentication setup script" >> $GITHUB_STEP_SUMMARY
